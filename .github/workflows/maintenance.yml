name: Maintenance

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday at midnight UTC

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Install Nix with Determinate
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Update flake.lock
        uses: DeterminateSystems/update-flake-lock@v28
        with:
          pr-title: "chore: Update flake.lock"
          pr-labels: |
            dependencies
            automated
          pr-body: |
            ## Automated flake.lock Update

            This PR updates the flake inputs to their latest versions.

            ### What's Updated
            - All flake inputs (nixpkgs, flake-utils, etc.)

            ### Testing
            - [ ] CI passes with updated dependencies
            - [ ] All builds complete successfully
            - [ ] Tests pass

            ðŸ¤– Generated by maintenance workflow

  dedup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    env:
      GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
    steps:
      - uses: actions/checkout@v5

      - name: Install Nix with Determinate
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Run duplicate detection
        id: dedup
        run: |
          set +e
          OUTPUT=$(nix run flakehub:Cambridge-Vision-Technology/purescript-dedup -- --src ./src --threshold 0.90 2>&1)
          EXIT_CODE=$?
          set -e

          {
            echo "exit_code=$EXIT_CODE"
            echo "output<<EOF"
            echo "$OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Print to logs
          echo "$OUTPUT"

      - name: Create issue if duplicates found
        if: steps.dedup.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.dedup.outputs.output }}`;
            const title = `ðŸ” Duplicate code detected in PureScript sources`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'duplicate-code,automated'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            const body = [
              '## Semantic Duplicate Detection Report',
              '',
              'The weekly maintenance scan found potential duplicate code in the PureScript sources.',
              '',
              '### Results',
              '```',
              output,
              '```',
              '',
              '### Action Required',
              'Review the flagged pairs and determine if refactoring is warranted. Not all duplicates need fixing:',
              '- Trivial helpers (2-3 lines) may be fine to duplicate',
              '- Structurally similar but logically distinct code is acceptable',
              '- High similarity (>90%) in core logic should be investigated',
              '',
              '### References',
              '- [Duplicate Detection Guidance](https://github.com/Cambridge-Vision-Technology/agen/wiki/purescript#duplicate-detection)',
              '',
              'ðŸ¤– Generated by maintenance workflow'
            ].join('\n');

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['duplicate-code', 'automated']
              });
              console.log('Created new issue');
            }

  scythe:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Install Nix with Determinate
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Run scythe dead code detection
        id: scythe
        run: |
          set -euo pipefail

          # Capture output and exit code - scythe returns non-zero when dead code found
          OUTPUT=$(nix run .#dead-code 2>&1) && EXIT_CODE=0 || EXIT_CODE=$?

          {
            echo "exit_code=$EXIT_CODE"
            echo "output<<SCYTHE_OUTPUT_EOF"
            echo "$OUTPUT"
            echo "SCYTHE_OUTPUT_EOF"
          } >> "$GITHUB_OUTPUT"

          # Print to logs
          echo "$OUTPUT"

      - name: Create issue if dead code found
        if: steps.scythe.outputs.exit_code != '0'
        uses: actions/github-script@v7
        env:
          SCYTHE_OUTPUT: ${{ steps.scythe.outputs.output }}
        with:
          script: |
            const output = process.env.SCYTHE_OUTPUT;
            const title = `ðŸª“ Scythe: dead code detected in PureScript sources`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scythe,automated'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            const body = [
              '## Scythe Dead Code Report',
              '',
              'The weekly maintenance scan found unused code in the PureScript sources.',
              '',
              '### Results',
              '```',
              output,
              '```',
              '',
              '### Action Required',
              'Review the flagged items and determine if they should be removed:',
              '- Functions that are truly unused can be safely deleted',
              '- Types only used by FFI may show as unused (check JS/TS files)',
              '- Some exports may be used by external consumers',
              '',
              'ðŸ¤– Generated by maintenance workflow'
            ].join('\n');

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scythe', 'automated']
              });
              console.log('Created new issue');
            }

  drop:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Install Nix with Determinate
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Run drop library suggestions
        id: drop
        run: |
          set -euo pipefail

          # Capture output - drop returns matches found (non-zero when suggestions exist)
          OUTPUT=$(nix run .#library-suggestions 2>&1) && EXIT_CODE=0 || EXIT_CODE=$?

          {
            echo "exit_code=$EXIT_CODE"
            echo "output<<DROP_OUTPUT_EOF"
            echo "$OUTPUT"
            echo "DROP_OUTPUT_EOF"
          } >> "$GITHUB_OUTPUT"

          # Print to logs
          echo "$OUTPUT"

      - name: Create issue if library suggestions found
        if: steps.drop.outputs.exit_code == '0' && contains(steps.drop.outputs.output, 'Possible match')
        uses: actions/github-script@v7
        env:
          DROP_OUTPUT: ${{ steps.drop.outputs.output }}
        with:
          script: |
            const output = process.env.DROP_OUTPUT;
            const title = `ðŸ“š Drop: library replacements found for local functions`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drop,automated'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            const body = [
              '## Drop Library Suggestions Report',
              '',
              'The weekly maintenance scan found local functions that could potentially be replaced with library functions from Pursuit.',
              '',
              '### Results',
              '```',
              output,
              '```',
              '',
              '### Action Required',
              'Review the suggestions and consider replacing local implementations:',
              '- Verify the suggested library function has the same semantics',
              '- Check if adding a new dependency is worthwhile',
              '- Some matches may be coincidental (same signature, different purpose)',
              '',
              '### References',
              '- [Pursuit](https://pursuit.purescript.org/) - PureScript package documentation',
              '',
              'ðŸ¤– Generated by maintenance workflow'
            ].join('\n');

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['drop', 'automated']
              });
              console.log('Created new issue');
            }
